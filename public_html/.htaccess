# ==============================================================
# Junxtion App - Apache Configuration
# ==============================================================

# --------------------------------------------------------------
# Force HTTPS (SSL)
# --------------------------------------------------------------
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# --------------------------------------------------------------
# Force www or non-www (choose one, uncomment preferred)
# --------------------------------------------------------------
# Force non-www
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Force www
# RewriteCond %{HTTP_HOST} !^www\. [NC]
# RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

# --------------------------------------------------------------
# Block access to dotfiles (except .well-known)
# --------------------------------------------------------------
RewriteCond %{REQUEST_URI} "!(^|/)\.well-known/([^./]+\.?)+$" [NC]
RewriteCond %{SCRIPT_FILENAME} -d [OR]
RewriteCond %{SCRIPT_FILENAME} -f
RewriteRule "(^|/)\." - [F]

# --------------------------------------------------------------
# Block access to sensitive files
# --------------------------------------------------------------
<FilesMatch "^(\.env|\.git|\.gitignore|composer\.(json|lock)|package(-lock)?\.json|README\.md|TESTING\.md)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Block backup and config files
<FilesMatch "\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|sw[op])$">
    Order allow,deny
    Deny from all
</FilesMatch>

# --------------------------------------------------------------
# Block access to private directories if accessible
# --------------------------------------------------------------
RedirectMatch 403 ^/private(/.*)?$
RedirectMatch 403 ^/migrations(/.*)?$

# --------------------------------------------------------------
# Security Headers
# --------------------------------------------------------------
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # XSS Protection
    Header always set X-XSS-Protection "1; mode=block"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy (formerly Feature-Policy)
    Header always set Permissions-Policy "geolocation=(self), microphone=(), camera=()"

    # Content Security Policy (adjust as needed)
    # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://payments.yoco.com https://fcm.googleapis.com;"

    # Remove server signature
    Header unset Server
    Header always unset X-Powered-By

    # Strict Transport Security (enable after SSL is confirmed working)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# Remove PHP version header
<IfModule mod_php.c>
    php_flag expose_php Off
</IfModule>

# --------------------------------------------------------------
# Prevent directory listing
# --------------------------------------------------------------
Options -Indexes

# --------------------------------------------------------------
# Set default charset
# --------------------------------------------------------------
AddDefaultCharset UTF-8

# --------------------------------------------------------------
# Enable compression
# --------------------------------------------------------------
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# --------------------------------------------------------------
# Browser Caching
# --------------------------------------------------------------
<IfModule mod_expires.c>
    ExpiresActive On

    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"

    # CSS & JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"

    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"

    # JSON & XML (shorter cache for API responses that might be cached)
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType application/xml "access plus 0 seconds"

    # HTML
    ExpiresByType text/html "access plus 0 seconds"

    # Manifest
    ExpiresByType application/manifest+json "access plus 1 week"
</IfModule>

# --------------------------------------------------------------
# URL Rewriting for Clean URLs
# --------------------------------------------------------------
RewriteEngine On

# Don't rewrite files or directories that exist
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Route API requests
RewriteRule ^api/(.*)$ /api/index.php [QSA,L]

# Route admin requests
RewriteRule ^admin/(.*)$ /admin/index.php [QSA,L]

# Route app requests to customer app
RewriteRule ^app/(.*)$ /app/index.php [QSA,L]

# Route everything else to main index
RewriteRule ^(.*)$ /index.php [QSA,L]

# --------------------------------------------------------------
# Error Documents
# --------------------------------------------------------------
ErrorDocument 400 /error.php?code=400
ErrorDocument 401 /error.php?code=401
ErrorDocument 403 /error.php?code=403
ErrorDocument 404 /error.php?code=404
ErrorDocument 500 /error.php?code=500
ErrorDocument 503 /error.php?code=503

# --------------------------------------------------------------
# Protect against common attacks
# --------------------------------------------------------------
# Block suspicious query strings
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
RewriteRule .* - [F,L]

# Block SQL injection attempts in query string
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=(\.\.//?)+ [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=/([a-z0-9_.]//?)+ [NC]
RewriteRule .* - [F,L]

# --------------------------------------------------------------
# File upload limits (adjust as needed)
# --------------------------------------------------------------
<IfModule mod_php.c>
    php_value upload_max_filesize 5M
    php_value post_max_size 6M
    php_value max_execution_time 60
    php_value max_input_time 60
</IfModule>
